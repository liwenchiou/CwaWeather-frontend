<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è«è˜­è¿ªæ°£è±¡æ—¥èªŒ | æ•¸æ“šç¸½çµç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* è«è˜­è¿ªè‰²ç³» */
            --morandi-bg-paper: #f8f5ed;    /* æº«æš–çš„ç±³ç™½è‰²ç´™å¼µèƒŒæ™¯ */
            --morandi-bg-card: #ece6da;     /* æ·ºç°ç±³è‰²å¡ç‰‡ */
            --morandi-text-dark: #3a3a3a;   /* æ·±ç°æ–‡å­— */
            --morandi-text-muted: #8d8d8d;  /* æ·ºç°æ–‡å­— */
            --morandi-accent-blue: #a3b8b1; /* ç°è— (é›¨å…·/æ¶¼çˆ½) */
            --morandi-accent-pink: #d4a7a7; /* ç°ç²‰ (æº«åº¦/æº«æš–) */
            --morandi-accent-green: #b6c4b6; /* ç°ç¶  (èˆ’é©/å¤©æ°£) */
            --morandi-line-pencil: #a8a8a8; /* é‰›ç­†ç° */
            --morandi-shadow: rgba(0, 0, 0, 0.08); /* è¼•æŸ”é™°å½± */

             /* ç§»é™¤æ‰‹ç¹ªæ¿¾é¡ä»¥å¢åŠ æ¸…æ™°åº¦ï¼Œä¿æŒé‚Šç·£æŸ”å’Œ */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', 'Roboto', sans-serif;
            background-color: var(--morandi-bg-paper);
            color: var(--morandi-text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 50px;
            position: relative;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><rect width="10" height="10" fill="transparent"/><circle cx="5" cy="5" r="0.5" fill="%23e0e0e0" opacity="0.1"/></svg>');
            background-repeat: repeat;
        }

        /* é ‚éƒ¨æ—¥æœŸèˆ‡åœ°é» */
        .status-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px 20px 15px;
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(2px);
            border-bottom: 1px solid var(--morandi-line-pencil);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px var(--morandi-shadow);
        }

        /* æ—¥èªŒæ¨™é¡Œ */
        .location-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-icon {
            font-size: 1.8rem;
            color: var(--morandi-accent-pink);
        }
        
        #locationLabel { 
            font-family: 'Noto Sans TC', sans-serif; 
            font-size: 1.6rem;
            color: var(--morandi-text-dark);
            font-weight: 500;
            letter-spacing: 1px;
        }

        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ (ç°¡æ½”åŒ–) */
        .city-select-container {
            position: relative;
            margin-left: 10px;
        }

        #citySelect {
            appearance: none;
            background: var(--morandi-bg-paper);
            border: 1px solid var(--morandi-line-pencil); 
            padding: 8px 30px 8px 15px;
            font-size: 1rem;
            color: var(--morandi-text-dark);
            cursor: pointer;
            border-radius: 4px; 
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 0 1px 3px var(--morandi-shadow);
            transition: all 0.2s ease;
        }

        #citySelect:focus {
            outline: none;
            border-color: var(--morandi-accent-blue);
            box-shadow: 0 0 5px rgba(163, 184, 177, 0.5);
        }

        /* ç®­é ­è£é£¾ */
        .city-select-container::after {
            content: 'âŒ„'; 
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%); 
            font-size: 1rem;
            color: var(--morandi-text-muted);
            pointer-events: none;
        }

        .update-pill {
            font-size: 0.8rem;
            font-weight: 300;
            color: var(--morandi-text-muted);
            text-align: center;
            padding: 5px 10px;
            border-bottom: 1px dotted var(--morandi-line-pencil);
            margin-top: 5px;
        }

        .container {
            padding: 20px;
            max-width: 800px;
            margin: 30px auto;
            position: relative;
            z-index: 1;
        }

        /* === æ ¸å¿ƒæ—¥èªŒå¡ç‰‡ (æ•¸æ“šç¸½çµå„ªå…ˆ) === */
        .hero-card {
            background: var(--morandi-bg-card);
            border: 2px solid var(--morandi-accent-blue); 
            padding: 30px 30px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            border-radius: 8px; 
            box-shadow: 0 5px 15px var(--morandi-shadow);
            overflow: hidden;
        }

        .hero-period {
            display: inline-block;
            background-color: var(--morandi-accent-green); /* ç°ç¶ è‰²æ¨™ç±¤ */
            color: var(--morandi-text-dark);
            padding: 6px 15px;
            font-size: 1.1rem;
            border-radius: 15px; 
            margin-bottom: 25px;
            font-weight: 500;
        }

        /* æ ¸å¿ƒæ•¸æ“šå€ (æœ€é«˜æº«/æœ€ä½æº«/é™é›¨æ©Ÿç‡) */
        .data-grid-core {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px dashed var(--morandi-line-pencil);
            border-bottom: 1px dashed var(--morandi-line-pencil);
            margin: 15px 0;
        }

        .data-item-core {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .data-value-core {
            font-family: 'Roboto', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
            color: var(--morandi-accent-pink); /* æº«åº¦ç”¨ç°ç²‰ */
        }
        /* é™é›¨æ©Ÿç‡ä½¿ç”¨ç°è—è‰² */
        .data-item-core:nth-child(3) .data-value-core {
             color: var(--morandi-accent-blue); 
        }

        .data-label-core {
            font-size: 0.9rem;
            color: var(--morandi-text-dark);
            opacity: 0.8;
            margin-top: 5px;
            font-weight: 400;
        }

        /* === ç©¿æ­æ±ºç­–ç¸½çµ (é†’ç›®) === */
        .action-summary-box {
            margin-top: 25px;
            padding: 18px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            line-height: 1.4;
            /* é è¨­ä½¿ç”¨èˆ’é©çš„ç°ç¶ è‰² */
            background-color: var(--morandi-accent-green); 
            color: var(--morandi-text-dark);
            box-shadow: 0 3px 8px var(--morandi-shadow);
        }
        
        .summary-icon {
            font-size: 1.5rem;
            margin-right: 8px;
        }
        .summary-text {
            font-size: 1.3rem;
            font-weight: 500;
        }


        /* === ç¨å¾Œé å ± - æ™‚é–“ç·šå°å¡ (ç¶­æŒä¸Šä¸€ç‰ˆé¢¨æ ¼) === */
        .section-title {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1.5rem;
            color: var(--morandi-accent-pink);
            margin: 40px 0 25px 0;
            font-weight: 500;
            letter-spacing: 1px;
            text-align: center;
            border-bottom: 1px dashed var(--morandi-line-pencil);
            padding-bottom: 5px;
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 10px 5px 25px 5px;
            scrollbar-width: none;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .mini-card {
            min-width: 110px;
            background: var(--morandi-bg-paper);
            border: 1px solid var(--morandi-line-pencil);
            padding: 15px 8px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 1px 3px var(--morandi-shadow);
        }
        
        .mini-time {
            color: var(--morandi-accent-blue);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: block;
        }

        .mini-icon {
            font-size: 2.2rem;
            margin: 5px 0;
            color: var(--morandi-accent-green);
        }

        .mini-temp {
            font-family: 'Roboto', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--morandi-text-dark);
        }

        .rain-data {
            font-size: 0.75rem;
            color: var(--morandi-text-muted);
            margin-top: 5px;
        }

        /* Loading & Error Styles */
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--morandi-bg-paper);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .loading-line {
            width: 100px; height: 3px; background: var(--morandi-line-pencil); border-radius: 2px;
            position: relative; overflow: hidden; margin-top: 20px;
        }
        .loading-line::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, var(--morandi-accent-pink), transparent);
            animation: data-flow 1.5s infinite linear;
        }
        @keyframes data-flow { 0% { left: -100%; } 100% { left: 100%; } }

        .loading-text {
            margin-top: 25px; font-size: 1.5rem; color: var(--morandi-accent-blue); font-weight: 400;
        }

        .error-card {
            background: var(--morandi-bg-card); border-radius: 8px; padding: 25px; margin: 50px auto;
            max-width: 500px; text-align: center; border: 1px dashed var(--morandi-accent-pink);
            color: var(--morandi-text-dark);
        }
        .error-card h2 { color: var(--morandi-accent-pink); margin-bottom: 10px; }

    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="loading-text">æ­£åœ¨ç¿»é–±æ°£è±¡æ—¥èªŒ...</div>
        <div class="loading-line"></div>
    </div>

    <div id="errorDisplay" class="error-card" style="display: none;">
        <h2>( Â´â€¢Ì¥Ì¥Ì¥Ï‰â€¢Ì¥Ì¥Ì¥` ) ç­†è¨˜æœ¬éºå¤±...</h2>
        <p id="errorMessage" style="color: var(--morandi-text-muted);"></p>
    </div>

    <div class="status-bar">
        <div class="location-pill">
            <span class="ai-icon">ğŸ“–</span> 
            <span id="locationLabel">ä»Šæ—¥å¤©æ°£æ—¥èªŒ</span> 
            <div class="city-select-container">
                <select id="citySelect" onchange="handleCityChange()">
                    </select>
            </div>
        </div>
        <div id="updateTime" class="update-pill">ä¸Šæ¬¡ç´€éŒ„æ™‚é–“ï¼š</div>
    </div>

    <div class="container" id="mainContent" style="display: none;">

        <div id="heroCard"></div>

        <h3 class="section-title">æœªä¾†å¹¾æ—¥çš„é å¯«ï¼š</h3>
        <div class="scroll-container" id="futureForecasts"></div>

    </div>

    <script>
        const BASE_API_URL = "https://liwen-weather-backend.zeabur.app/api/weather/";
        let currentCity = "æ¡ƒåœ’å¸‚"; 

        const TAIWAN_CITIES = [
            "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "è‡ºä¸­å¸‚", "è‡ºå—å¸‚", "é«˜é›„å¸‚", 
            "åŸºéš†å¸‚", "æ–°ç«¹å¸‚", "å˜‰ç¾©å¸‚", 
            "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©ç¸£", 
            "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"
        ];
        
        // --- æ ¸å¿ƒå‡½æ•¸ ---

        function getWeatherIcon(weather) {
            if (!weather) return "ã€°ï¸"; 
            if (weather.includes("æ™´")) return "â˜€ï¸"; 
            if (weather.includes("å¤šé›²")) return "ğŸŒ¥ï¸"; 
            if (weather.includes("é™°")) return "â˜ï¸"; 
            if (weather.includes("é›¨")) return "ğŸ’§"; 
            if (weather.includes("é›·")) return "âš¡"; 
            return "ğŸŒ¤ï¸"; 
        }

        function getTimePeriod(startTime) {
            const hour = new Date(startTime).getHours();
            if (hour >= 5 && hour < 11) return "æ¸…æ™¨æ—¥å‡ºæ™‚åˆ†"; 
            if (hour >= 11 && hour < 13) return "æ­£åˆæš–é™½ä¹‹ä¸‹"; 
            if (hour >= 13 && hour < 17) return "åˆå¾Œæ™‚å…‰æ¼«æ¼«"; 
            if (hour >= 17 && hour < 19) return "æ—¥è½é»ƒæ˜ä¹‹éš›"; 
            if (hour >= 19 && hour < 23) return "å¤œå¹•ä½å‚ä¹‹å¾Œ"; 
            return "éœè¬æ·±å¤œä¹‹éš›"; 
        }
        
        // **æ ¸å¿ƒåŠŸèƒ½**ï¼šä¸€å¥è©±ç¸½çµä»Šæ—¥å»ºè­°
        function getActionSummary(rainProb, minTemp, maxTemp) {
            const rainValue = parseInt(rainProb);
            const minValue = parseInt(minTemp);
            const maxValue = parseInt(maxTemp);

            let rainAdvice = "ç„¡é ˆå‚™å‚˜ã€‚";
            let rainIcon = "ğŸŒ¤ï¸";
            if (rainValue > 60) {
                rainAdvice = "å¼·çƒˆå»ºè­°æ”œå¸¶é›¨å…·ã€‚";
                rainIcon = "â˜”";
            } else if (rainValue > 30) {
                rainAdvice = "è«‹æ”œå¸¶é›¨å…·ï¼Œé é˜²é™é›¨ã€‚";
                rainIcon = "â˜‚ï¸";
            } 

            let tempAdvice = "";
            let tempIcon = "ğŸ§¥";
            
            if (maxValue >= 30) {
                tempAdvice = "æ°£æº«ç‚ç†±ï¼Œå®œç©¿è‘—çŸ­è¢–ã€‚";
                tempIcon = "ğŸ‘•";
            } else if (minValue <= 18) {
                tempAdvice = "æ¸…æ™¨ä½æº«åæ¶¼ï¼Œéœ€è¦å¤–å¥—ä¿æš–ã€‚";
                tempIcon = "ğŸ§¥";
            } else if (minValue <= 15) {
                tempAdvice = "å¤©æ°£å¯’å†·ï¼Œè«‹ç©¿è‘—åšå¤–å¥—ã€‚";
                tempIcon = "ğŸ§£";
            } else {
                tempAdvice = "æ°£æº«é©ä¸­ï¼Œæ™®é€šè¡£ç‰©å³å¯ã€‚";
                tempIcon = "ğŸ‘š";
            }

            // èª¿æ•´ç¸½çµæ¡†é¡è‰²
            let summaryColor = "var(--morandi-accent-green)"; // é è¨­èˆ’é©ç°ç¶ 
            if (rainValue > 30) {
                summaryColor = "var(--morandi-accent-blue)"; // ç°è—è‰²å¼·èª¿é›¨å…·
            } else if (minValue <= 18 || maxValue >= 30) {
                summaryColor = "var(--morandi-accent-pink)"; // ç°ç²‰è‰²å¼·èª¿æº«å·®
            }
            
            return {
                text: `${tempAdvice} | ${rainAdvice}`,
                icon: `${tempIcon} ${rainIcon}`,
                color: summaryColor
            };
        }

        // --- æ¸²æŸ“å‡½æ•¸ ---

        function renderWeather(data) {
            const forecasts = data.forecasts;
            if (!forecasts || forecasts.length === 0) {
                showError("ç„¡æ³•å–å¾—ä»Šæ—¥çš„æ°£è±¡æ•¸æ“šï¼Œç­†è¨˜æœ¬è¢«é¢¨å¹èµ°äº†...");
                return;
            }

            const current = forecasts[0];
            const others = forecasts.slice(1);

            document.getElementById('locationLabel').textContent = data.city + ' | ä»Šæ—¥å¤©æ°£æ—¥èªŒ'; 
            
            const minT = parseInt(current.minTemp);
            const maxT = parseInt(current.maxTemp);
            const rainValue = parseInt(current.rain);
            const period = getTimePeriod(current.startTime);
            
            const summary = getActionSummary(rainValue, minT, maxT);

            document.getElementById('heroCard').innerHTML = `
                <div class="hero-card">
                    <div class="hero-period">â˜€ï¸ ${period} ç´€éŒ„ â˜€ï¸</div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0;">
                        <span style="font-size: 3rem; color: var(--morandi-accent-green);">${getWeatherIcon(current.weather)}</span>
                        <span style="font-size: 1.5rem; font-weight: 500; color: var(--morandi-text-dark);">${current.weather}</span>
                    </div>

                    <div class="data-grid-core">
                        <div class="data-item-core">
                            <div class="data-value-core">${maxT}Â°C</div>
                            <div class="data-label-core">æœ€é«˜æº«</div>
                        </div>
                        <div class="data-item-core">
                            <div class="data-value-core">${minT}Â°C</div>
                            <div class="data-label-core">æœ€ä½æº«</div>
                        </div>
                        <div class="data-item-core">
                            <div class="data-value-core">${rainValue}%</div>
                            <div class="data-label-core">é™é›¨æ©Ÿç‡</div>
                        </div>
                    </div>

                    <div class="action-summary-box" style="background-color: ${summary.color};">
                        <span class="summary-icon">${summary.icon}</span>
                        <span class="summary-text">${summary.text}</span>
                    </div>
                </div>
            `;

            // æ¸²æŸ“æœªä¾†é å ± (ç¶­æŒä¸Šä¸€ç‰ˆçµæ§‹)
            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            const todayDate = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime);
                const fDate = new Date(f.startTime);
                let dayLabel = (fDate.getDate() !== todayDate) ? "æ˜æ—¥" : "ä»Šæ—¥";

                const miniMinT = parseInt(f.minTemp);
                const miniMaxT = parseInt(f.maxTemp);
                const miniRain = parseInt(f.rain);

                scrollContainer.innerHTML += `
                    <div class="mini-card">
                        <div class="mini-time">${dayLabel} | ${p}</div>
                        <div class="mini-icon">${getWeatherIcon(f.weather)}</div>
                        <div class="mini-temp">${miniMinT} ~ ${miniMaxT}Â°C</div>
                        <div class="rain-data">é›¨æ°´æ©Ÿç‡: ${miniRain}%</div>
                    </div>
                `;
            });

            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit', second: '2-digit', hour12: false});
            document.getElementById('updateTime').innerHTML = `ä¸Šæ¬¡ç´€éŒ„æ™‚é–“ï¼š${timeStr}`;
            
            hideLoading();
        }

        // éŒ¯èª¤å¡ç‰‡å‡½æ•¸
        function showError(message, detailedError = "") {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = `${message} <br><small style="color: var(--morandi-text-muted);">è©³ç´°å‚™è¨»ï¼š${detailedError}</small>`;
        }

        // éš±è— Loading ç•«é¢
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function loadCities() {
            const selectElement = document.getElementById('citySelect');
            selectElement.innerHTML = ''; 
            TAIWAN_CITIES.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === currentCity) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }
        
        function handleCityChange() {
            const selectElement = document.getElementById('citySelect');
            currentCity = selectElement.value;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.querySelector('.loading-text').innerText = "æ­£åœ¨ç‚ºæ–°åŸå¸‚ç¿»é–±æ—¥èªŒ...";
            fetchWeather();
        }

        async function fetchWeather() {
            if (!currentCity) {
                showError("ç›®æ¨™åŸå¸‚æœªå®šç¾©ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚");
                return;
            }

            const API_URL = BASE_API_URL + encodeURIComponent(currentCity);

            try {
                const delayPromise = new Promise(resolve => setTimeout(resolve, 800)); 
                const response = await fetch(API_URL); 

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤ï¼šç‹€æ…‹ç¢¼ ${response.status}`);
                }

                const [_, json] = await Promise.all([delayPromise, response.json()]);

                if (json.success) {
                    renderWeather(json.data);
                } else {
                    showError("ä»Šæ—¥æ•¸æ“šé é¢ç•°å¸¸ï¼Œç„¡æ³•è®€å–å®Œæ•´ç´€éŒ„ã€‚", json.message || "API éŸ¿æ‡‰å¤±æ•—");
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                showError("ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ç‹€æ…‹ï¼", e.message);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            loadCities();
            fetchWeather();
        });
    </script>
</body>

</html>